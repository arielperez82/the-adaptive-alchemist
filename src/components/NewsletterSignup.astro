---
// NewsletterSignup.astro - Newsletter subscription form with double opt-in
---

<div
  class="rounded-xl border border-zinc-200 bg-zinc-50 p-6 transition-all duration-300 dark:border-zinc-800 dark:bg-zinc-800/50"
  id="newsletter-signup"
>
  <h3
    class="mb-2 text-lg font-semibold text-zinc-900 transition-colors duration-300 dark:text-zinc-100"
  >
    Subscribe to the newsletter
  </h3>
  <p
    class="mb-4 text-sm text-zinc-600 transition-colors duration-300 dark:text-zinc-400"
  >
    Get notified when new articles are published
  </p>

  <form id="newsletter-form" class="space-y-3">
    <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
      <input
        type="text"
        id="firstName"
        name="firstName"
        placeholder="First name"
        class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder-zinc-400 transition-all duration-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-zinc-800 disabled:opacity-50 dark:border-zinc-600 dark:bg-zinc-700 dark:text-zinc-100 dark:placeholder-zinc-400 dark:focus:ring-zinc-200"
        disabled
      />
      <input
        type="text"
        id="lastName"
        name="lastName"
        placeholder="Last name (optional)"
        class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder-zinc-400 transition-all duration-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-zinc-800 disabled:opacity-50 dark:border-zinc-600 dark:bg-zinc-700 dark:text-zinc-100 dark:placeholder-zinc-400 dark:focus:ring-zinc-200"
        disabled
      />
    </div>

    <div>
      <input
        type="email"
        id="email"
        name="email"
        placeholder="Enter your email"
        class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 placeholder-zinc-400 transition-all duration-300 focus:border-transparent focus:outline-none focus:ring-2 focus:ring-zinc-800 disabled:opacity-50 dark:border-zinc-600 dark:bg-zinc-700 dark:text-zinc-100 dark:placeholder-zinc-400 dark:focus:ring-zinc-200"
        required
        disabled
      />
    </div>

    <button
      type="submit"
      id="submit-button"
      class="w-full cursor-pointer rounded-lg bg-zinc-900 px-4 py-2 text-sm font-medium text-white transition-all duration-300 hover:bg-zinc-800 disabled:cursor-not-allowed disabled:opacity-50 dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200"
      disabled
    >
      Subscribe
    </button>
  </form>

  <div
    id="message"
    class="mt-3 hidden rounded-lg p-3 text-sm transition-all duration-300"
  >
  </div>
</div>

<script>
  // Newsletter signup form handling
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('newsletter-form') as HTMLFormElement
    const emailInput = document.getElementById('email') as HTMLInputElement
    const firstNameInput = document.getElementById(
      'firstName'
    ) as HTMLInputElement
    const lastNameInput = document.getElementById(
      'lastName'
    ) as HTMLInputElement
    const submitButton = document.getElementById(
      'submit-button'
    ) as HTMLButtonElement
    const messageDiv = document.getElementById('message') as HTMLDivElement

    if (
      !form ||
      !emailInput ||
      !firstNameInput ||
      !lastNameInput ||
      !submitButton ||
      !messageDiv
    ) {
      return
    }

    // Enable form inputs
    emailInput.disabled = false
    firstNameInput.disabled = false
    lastNameInput.disabled = false
    submitButton.disabled = false

    const showMessage = (message: string, type: 'success' | 'error') => {
      messageDiv.textContent = message
      messageDiv.className = `mt-3 rounded-lg p-3 text-sm transition-all duration-300 ${
        type === 'success'
          ? 'bg-zinc-100 text-zinc-800 dark:bg-zinc-800 dark:text-zinc-200'
          : 'bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-300'
      }`
      messageDiv.classList.remove('hidden')
    }

    const hideMessage = () => {
      messageDiv.classList.add('hidden')
    }

    const setLoading = (loading: boolean) => {
      submitButton.disabled = loading
      emailInput.disabled = loading
      firstNameInput.disabled = loading
      lastNameInput.disabled = loading
      submitButton.textContent = loading ? 'Subscribing...' : 'Subscribe'
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault()

      const email = emailInput.value.trim()
      const firstName = firstNameInput.value.trim()
      const lastName = lastNameInput.value.trim()

      if (!email || !firstName) {
        showMessage('Please provide your email and first name.', 'error')
        return
      }

      setLoading(true)
      hideMessage()

      try {
        const response = await fetch(
          `${import.meta.env.PUBLIC_SUPABASE_URL}/functions/v1/subscribe`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${import.meta.env.PUBLIC_SUPABASE_ANON_KEY!}`
            },
            body: JSON.stringify({ email, firstName, lastName })
          }
        )

        const data = await response.json()

        if (response.ok) {
          showMessage(data.message, 'success')
          // Clear form on success
          emailInput.value = ''
          firstNameInput.value = ''
          lastNameInput.value = ''
        } else {
          showMessage(
            data.error || 'Something went wrong. Please try again.',
            'error'
          )
        }
      } catch (error) {
        console.error('Newsletter signup error:', error)
        showMessage('Network error. Please try again.', 'error')
      } finally {
        setLoading(false)
      }
    })
  })
</script>
